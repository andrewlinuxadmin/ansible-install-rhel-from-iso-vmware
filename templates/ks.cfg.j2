#version=RHEL9
# {{ ansible_managed }}
# Kickstart file automatically generated by Ansible

# ── Installation ────────────────────────────────────────────────
graphical
reboot --eject

# ── Installation source (local media = ISO mounted on CD-ROM) ──
cdrom

# ── Localization ───────────────────────────────────────────────
lang {{ ks_locale }}
keyboard --xlayouts='{{ ks_keyboard }}'
timezone {{ ks_timezone }} --utc

# ── Network ────────────────────────────────────────────────────
network --bootproto=static --device=ens192 --ip={{ vm_network_ip }} --netmask={{ vm_network_mask }} --gateway={{ vm_network_gateway }} --nameserver={{ vm_network_dns }} --hostname={{ vm_hostname }} --activate
network --hostname={{ vm_hostname }}

# ── Security ───────────────────────────────────────────────────
firewall --enabled --service=ssh
selinux --enforcing
{% if ks_root_password.startswith('$') %}
rootpw --iscrypted {{ ks_root_password }}
{% else %}
rootpw --plaintext {{ ks_root_password }}
{% endif %}

# ── User ───────────────────────────────────────────────────────
{% if ks_user_name is defined %}
user --name={{ ks_user_name }} --password={{ ks_user_password }} {{ '--iscrypted' if ks_user_password.startswith('$') else '--plaintext' }} --gecos="{{ ks_user_gecos | default('') }}"{{ ' --groups=wheel' if ks_user_is_admin | default(false) | bool else '' }}
{% endif %}

# ── Bootloader ─────────────────────────────────────────────────
bootloader --boot-drive={{ ks_disk_device }}

# ── Partitioning (LVM) ────────────────────────────────────────
zerombr
{% if vm_extra_disk is defined %}
clearpart --all --initlabel --drives={{ ks_disk_device }},{{ vm_extra_disk.device }}
ignoredisk --only-use={{ ks_disk_device }},{{ vm_extra_disk.device }}
{% else %}
clearpart --all --initlabel --drives={{ ks_disk_device }}
ignoredisk --only-use={{ ks_disk_device }}
{% endif %}

part /boot     --fstype="xfs"  --ondisk={{ ks_disk_device }} --size=1024
part /boot/efi --fstype="efi"  --ondisk={{ ks_disk_device }} --size=600 --fsoptions="umask=0077,shortname=winnt"
part pv.01     --fstype="lvmpv" --ondisk={{ ks_disk_device }} --size=1 --grow

volgroup {{ ks_vg_name }} pv.01

{% for lv in ks_lvs %}
logvol {{ lv.mount }} --fstype="{{ lv.fstype | default('xfs') }}" --vgname={{ ks_vg_name }} --name={{ lv.name }} --size={{ lv.size }}
{% endfor %}

{% if vm_extra_disk is defined %}
# ── Extra disk: {{ vm_extra_disk.device }} ──
part pv.02 --fstype="lvmpv" --ondisk={{ vm_extra_disk.device }} --size=1 --grow
volgroup {{ vm_extra_disk.vg_name }} pv.02
{% for lv in vm_extra_disk.lvs %}
logvol {{ lv.mount }} --fstype="{{ lv.fstype | default('xfs') }}" --vgname={{ vm_extra_disk.vg_name }} --name={{ lv.name }} --size={{ lv.size }}
{% endfor %}
{% endif %}

# ── Packages ───────────────────────────────────────────────────
%packages
@^server-product-environment
{% if ks_extra_packages is defined %}
{% for pkg in ks_extra_packages %}
{{ pkg }}
{% endfor %}
{% endif %}
%end

# ── Post-installation scripts ──────────────────────────────────
%post --log=/root/ks-post.log
echo "=== Kickstart post-install $(date) ==="

{% if ks_ssh_config is defined %}
{% for key, value in ks_ssh_config.items() %}
sed -i 's/^#\?{{ key }}.*/{{ key }} {{ value }}/' /etc/ssh/sshd_config
{% endfor %}
{% endif %}

systemctl enable sshd
%end
