---
# ═══════════════════════════════════════════════════════════════════
# 0. CHECK IF VM ALREADY EXISTS AND VALIDATE VARIABLES
# ═══════════════════════════════════════════════════════════════════

- name: Check if VM already exists
  community.vmware.vmware_guest_info:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: "{{ vcenter_validate_certs }}"
    datacenter: "{{ vcenter_datacenter }}"
    name: "{{ vm_name }}"
  register: _vm_exists
  failed_when: false
  delegate_to: localhost

- name: Abort if VM already exists
  ansible.builtin.fail:
    msg: >-
      VM '{{ vm_name }}' already exists.
      Delete it manually or use a different vm_name.
  when:
    - _vm_exists.instance is defined
    - not (vm_force_recreate | default(false) | bool)

- name: Destroy existing VM (force recreate)
  community.vmware.vmware_guest:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: "{{ vcenter_validate_certs }}"
    name: "{{ vm_name }}"
    state: absent
    force: true
  delegate_to: localhost
  when:
    - _vm_exists.instance is defined
    - vm_force_recreate | default(false) | bool

- name: Validate required variables
  ansible.builtin.assert:
    that:
      # vCenter / ESXi
      - vcenter_hostname is defined
      - vcenter_username is defined
      - vcenter_password is defined
      - vcenter_datacenter is defined
      - vcenter_datastore is defined
      - vcenter_cluster is defined
      - vcenter_network is defined
      # VM
      - vm_name is defined
      # Network
      - vm_network_ip is defined
      - vm_network_mask is defined
      - vm_network_gateway is defined
      - vm_network_dns is defined
      - vm_hostname is defined
      # ISO
      - rhel_iso_path is defined
      # OS / Kickstart
      - ks_root_password is defined
      - ks_timezone is defined
    fail_msg: >-
      One or more required variables are not defined.
      Check the include_role vars in install.yml.

- name: Validate additional user variables
  ansible.builtin.assert:
    that:
      - ks_user_password is defined
    fail_msg: >-
      ks_user_name is defined but ks_user_password is missing.
      Both are required to create an additional user.
  when: ks_user_name is defined

- name: Validate root partition exists in ks_lvs
  ansible.builtin.assert:
    that:
      - ks_lvs | selectattr('mount', 'equalto', '/') | list | length > 0
    fail_msg: >-
      ks_lvs must contain at least one entry with mount: /
      for the root partition.

- name: Validate OS disk LV sizes fit within disk
  ansible.builtin.assert:
    that:
      - >-
        ks_lvs | map(attribute='size') | sum
        <= (vm_disk_size_in_gb * 1024) - 1624
    fail_msg: >-
      OS disk LV total
      ({{ ks_lvs | map(attribute='size') | sum }} MB)
      exceeds available LVM space
      ({{ vm_disk_size_in_gb }} GB minus 1624 MB for
      /boot + /boot/efi =
      {{ (vm_disk_size_in_gb * 1024) - 1624 }} MB).

- name: Validate extra disk LV sizes fit within disk
  ansible.builtin.assert:
    that:
      - >-
        vm_extra_disk.lvs | map(attribute='size') | sum
        <= vm_extra_disk.size_gb * 1024
    fail_msg: >-
      Extra disk LV total
      ({{ vm_extra_disk.lvs | map(attribute='size') | sum }} MB)
      exceeds disk capacity
      ({{ vm_extra_disk.size_gb }} GB =
      {{ vm_extra_disk.size_gb * 1024 }} MB).
  when: vm_extra_disk is defined

# ═══════════════════════════════════════════════════════════════════
# 1. BUILD KICKSTART ISO
# ═══════════════════════════════════════════════════════════════════

- name: Create kickstart content directory
  ansible.builtin.file:
    path: "{{ ks_iso_work_dir }}/content"
    state: directory
    mode: "0755"
  delegate_to: localhost

- name: Render Kickstart template
  ansible.builtin.template:
    src: ks.cfg.j2
    dest: "{{ ks_iso_work_dir }}/content/{{ ks_filename }}"
    mode: "0644"
  delegate_to: localhost

- name: Check if ksvalidator is available
  ansible.builtin.command:
    cmd: which ksvalidator
  register: _ksvalidator
  changed_when: false
  failed_when: false
  delegate_to: localhost

- name: Validate kickstart file with ksvalidator
  ansible.builtin.command:
    cmd: >-
      ksvalidator
      {{ ks_iso_work_dir }}/content/{{ ks_filename }}
  changed_when: false
  delegate_to: localhost
  when: _ksvalidator.rc == 0

- name: Remove old kickstart ISO if it exists
  ansible.builtin.file:
    path: "{{ ks_iso_image }}"
    state: absent
  delegate_to: localhost

- name: Build kickstart ISO image
  ansible.builtin.command:
    cmd: >-
      xorrisofs -o {{ ks_iso_image }}
      -V {{ ks_iso_label }} -r -J
      {{ ks_iso_work_dir }}/content
  changed_when: true
  delegate_to: localhost

- name: Verify kickstart ISO contents
  ansible.builtin.command:
    cmd: xorriso -indev {{ ks_iso_image }} -ls /
  register: _ks_iso_contents
  changed_when: false
  delegate_to: localhost

- name: Display kickstart ISO contents
  ansible.builtin.debug:
    var: _ks_iso_contents.stdout_lines

# ═══════════════════════════════════════════════════════════════════
# 2. UPLOAD KICKSTART ISO TO DATASTORE
# ═══════════════════════════════════════════════════════════════════

- name: Ensure kickstart directory exists on datastore
  community.vmware.vsphere_file:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: "{{ vcenter_validate_certs }}"
    datacenter: "{{ vcenter_datacenter }}"
    datastore: "{{ ks_iso_datastore }}"
    path: "{{ ks_iso_datastore_dir }}"
    state: directory
  delegate_to: localhost

- name: Upload kickstart ISO to datastore
  community.vmware.vsphere_copy:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: "{{ vcenter_validate_certs }}"
    datacenter: "{{ vcenter_datacenter }}"
    datastore: "{{ ks_iso_datastore }}"
    src: "{{ ks_iso_image }}"
    path: "{{ ks_iso_datastore_dir }}/{{ vm_name }}-ks.iso"
  delegate_to: localhost

# ═══════════════════════════════════════════════════════════════════
# 3. CREATE VM WITH INSTALL ISO + KICKSTART ISO
# ═══════════════════════════════════════════════════════════════════

- name: Create VM on vSphere
  community.vmware.vmware_guest:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: "{{ vcenter_validate_certs }}"
    datacenter: "{{ vcenter_datacenter }}"
    cluster: "{{ vcenter_cluster }}"
    folder: "{{ vcenter_folder | default(omit) }}"
    name: "{{ vm_name }}"
    guest_id: "{{ vm_guest_id }}"
    state: present
    hardware:
      memory_mb: "{{ vm_memory_mb }}"
      num_cpus: "{{ vm_num_cpus }}"
    disk: >-
      {{
        [{"size_gb": vm_disk_size_in_gb, "type": vm_disk_type, "datastore": vcenter_datastore}]
        + ( [{"size_gb": vm_extra_disk.size_gb, "type": vm_extra_disk.type | default(vm_disk_type), "datastore": vcenter_datastore}]
            if vm_extra_disk is defined else [] )
      }}
    networks:
      - name: "{{ vcenter_network }}"
        device_type: vmxnet3
    cdrom:
      - controller_number: 0
        unit_number: 0
        type: iso
        iso_path: "{{ rhel_iso_path }}"
        state: present
      - controller_number: 0
        unit_number: 1
        type: iso
        iso_path: "{{ ks_iso_datastore_path }}"
        state: present
  register: vm_result
  delegate_to: localhost

# ═══════════════════════════════════════════════════════════════════
# 4. POWER ON VM (OEMDRV auto-detected by Anaconda)
# ═══════════════════════════════════════════════════════════════════

- name: Power on the VM
  community.vmware.vmware_guest_powerstate:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: "{{ vcenter_validate_certs }}"
    name: "{{ vm_name }}"
    state: powered-on
  delegate_to: localhost

# ═══════════════════════════════════════════════════════════════════
# 5. WAIT FOR INSTALLATION TO COMPLETE
# ═══════════════════════════════════════════════════════════════════

- name: Wait for VM to obtain IP (installation + reboot)
  community.vmware.vmware_guest_info:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: "{{ vcenter_validate_certs }}"
    datacenter: "{{ vcenter_datacenter }}"
    name: "{{ vm_name }}"
  register: vm_info
  until: vm_info.instance.ipv4 is defined and vm_info.instance.ipv4 is not none and vm_info.instance.ipv4 | length > 0
  retries: "{{ (vm_wait_for_ip_timeout / 30) | int }}"
  delay: 30
  delegate_to: localhost

- name: Wait for SSH to become available
  ansible.builtin.wait_for:
    host: "{{ vm_info.instance.ipv4 }}"
    port: 22
    timeout: 300
  delegate_to: localhost

# ═══════════════════════════════════════════════════════════════════
# 7. CLEANUP — UNMOUNT ISOS AND CLEAN UP TEMP FILES
# ═══════════════════════════════════════════════════════════════════

- name: Shut down VM to remove devices
  community.vmware.vmware_guest_powerstate:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: "{{ vcenter_validate_certs }}"
    name: "{{ vm_name }}"
    state: shutdown-guest
  delegate_to: localhost

- name: Wait for VM to fully power off
  community.vmware.vmware_guest_info:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: "{{ vcenter_validate_certs }}"
    datacenter: "{{ vcenter_datacenter }}"
    name: "{{ vm_name }}"
  register: _vm_power
  until: _vm_power.instance.hw_power_status == "poweredOff"
  retries: 20
  delay: 5
  delegate_to: localhost

- name: Unmount ISOs and remove kickstart CD-ROM
  community.vmware.vmware_guest:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: "{{ vcenter_validate_certs }}"
    name: "{{ vm_name }}"
    cdrom:
      - controller_number: 0
        unit_number: 0
        type: none
        state: present
      - controller_number: 0
        unit_number: 1
        type: none
        state: absent
  delegate_to: localhost

- name: Power on the VM again
  community.vmware.vmware_guest_powerstate:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: "{{ vcenter_validate_certs }}"
    name: "{{ vm_name }}"
    state: powered-on
  delegate_to: localhost

- name: Wait for SSH to become available after restart
  ansible.builtin.wait_for:
    host: "{{ vm_info.instance.ipv4 }}"
    port: 22
    timeout: 300
  delegate_to: localhost

- name: Remove kickstart ISO from datastore
  community.vmware.vsphere_file:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: "{{ vcenter_validate_certs }}"
    datacenter: "{{ vcenter_datacenter }}"
    datastore: "{{ ks_iso_datastore }}"
    path: "{{ ks_iso_datastore_dir }}/{{ vm_name }}-ks.iso"
    state: absent
  delegate_to: localhost

- name: Clean up local temporary files
  ansible.builtin.file:
    path: "{{ ks_iso_work_dir }}"
    state: absent
  delegate_to: localhost
