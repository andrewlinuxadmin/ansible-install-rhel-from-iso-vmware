---
# ═══════════════════════════════════════════════════════════════════
# CHECK IF VM ALREADY EXISTS
# ═══════════════════════════════════════════════════════════════════

- name: Check if VM already exists
  community.vmware.vmware_guest_info:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: "{{ vcenter_validate_certs }}"
    datacenter: "{{ vcenter_datacenter }}"
    name: "{{ vm_name }}"
  register: _vm_exists
  failed_when: false
  delegate_to: localhost

- name: Set VM existence flag
  ansible.builtin.set_fact:
    _vm_already_exists: >-
      {{ _vm_exists.instance is defined
         and not (vm_force_recreate | default(false) | bool) }}

- name: VM already exists
  ansible.builtin.debug:
    msg: >-
      VM '{{ vm_name }}' already exists. Skipping creation.
      Use vm_force_recreate=true to delete and recreate it.
  when: _vm_already_exists | bool

- name: Provision VM
  ansible.builtin.include_tasks: install.yml
  when: not (_vm_already_exists | bool)
